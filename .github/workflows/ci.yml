name: CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - ".github/workflows/ci.yml"
      - "api/**"
      - "web/**"
      - "docs/**"
  pull_request:
    branches: [ main, develop ]
    paths:
      - ".github/workflows/ci.yml"
      - "api/**"
      - "web/**"
      - "docs/**"

# Toggle hard enforcement without editing steps:
# Set repository/environment variable ENFORCE_GUARDRAILS=true to make failures block merges.
env:
  PHP_VERSION: "8.3"
  NODE_VERSION: "20.x"
  ENFORCE_GUARDRAILS: "false"

permissions:
  contents: read
  pull-requests: read

jobs:
  meta:
    name: Meta (changed-paths only)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: List changed files (debug)
        uses: tj-actions/changed-files@v45
        with:
          since_last_remote_commit: true

  backend:
    name: Backend (PHP/Laravel) — PHPCS / PHPStan / Psalm / PHPUnit / Enlightn / Composer Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Detect project layout
      - name: Detect /api presence
        id: detect_api
        run: |
          if [ -d "api" ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Detect composer.json
        if: steps.detect_api.outputs.present == 'true'
        id: detect_composer
        run: |
          if [ -f "api/composer.json" ]; then
            echo "has_composer=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_composer=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup PHP
        if: steps.detect_api.outputs.present == 'true' && steps.detect_composer.outputs.has_composer == 'true'
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          coverage: none
          tools: composer, cs2pr
          extensions: mbstring, intl, zip, gd, pdo_mysql
          ini-values: memory_limit=1G, error_reporting=E_ALL

      - name: Composer cache
        if: steps.detect_api.outputs.present == 'true' && steps.detect_composer.outputs.has_composer == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache/files
            api/vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('api/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        if: steps.detect_api.outputs.present == 'true' && steps.detect_composer.outputs.has_composer == 'true'
        working-directory: api
        run: composer install --no-interaction --prefer-dist

      # ========== PHPCS ==========
      - name: PHPCS (PSR-12)
        if: steps.detect_api.outputs.present == 'true' && steps.detect_composer.outputs.has_composer == 'true'
        working-directory: api
        run: |
          if [ -f "vendor/bin/phpcs" ]; then
            vendor/bin/phpcs --standard=PSR12 --report=checkstyle | cs2pr
          else
            echo "::notice title=PHPCS::phpcs not found. Add squizlabs/php_codesniffer to require-dev."
          fi
        continue-on-error: ${{ env.ENFORCE_GUARDRAILS != 'true' }}

      # ========== PHPStan ==========
      - name: PHPStan (Level 5 target)
        if: steps.detect_api.outputs.present == 'true' && steps.detect_composer.outputs.has_composer == 'true'
        working-directory: api
        run: |
          if [ -f "vendor/bin/phpstan" ]; then
            vendor/bin/phpstan analyse --no-progress --level=max || vendor/bin/phpstan analyse --no-progress --level=5
          else
            echo "::notice title=PHPStan::phpstan not found. Add phpstan/phpstan (and larastan) to require-dev."
          fi
        continue-on-error: ${{ env.ENFORCE_GUARDRAILS != 'true' }}

      # ========== Psalm ==========
      - name: Psalm (no-new-issues intent)
        if: steps.detect_api.outputs.present == 'true' && steps.detect_composer.outputs.has_composer == 'true'
        working-directory: api
        run: |
          if [ -f "vendor/bin/psalm" ]; then
            vendor/bin/psalm --no-cache --taint-analysis --output-format=github
          else
            echo "::notice title=Psalm::psalm not found. Add vimeo/psalm and psalm/plugin-laravel to require-dev."
          fi
        continue-on-error: ${{ env.ENFORCE_GUARDRAILS != 'true' }}

      # ========== PHPUnit ==========
      - name: PHPUnit
        if: steps.detect_api.outputs.present == 'true' && steps.detect_composer.outputs.has_composer == 'true'
        working-directory: api
        run: |
          if [ -f "vendor/bin/phpunit" ]; then
            vendor/bin/phpunit --no-coverage
          else
            echo "::notice title=PHPUnit::phpunit not found. Add phpunit/phpunit to require-dev."
          fi
        continue-on-error: ${{ env.ENFORCE_GUARDRAILS != 'true' }}

      # ========== Enlightn ==========
      - name: Enlightn Security Checks
        if: steps.detect_api.outputs.present == 'true' && steps.detect_composer.outputs.has_composer == 'true'
        working-directory: api
        env:
          APP_ENV: testing
          APP_KEY: base64:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
        run: |
          if [ -f "artisan" ] && [ -f "vendor/bin/enlightn" ]; then
            php artisan enlightn --ci
          else
            echo "::notice title=Enlightn::package not present or no artisan. Add enlightn/enlightn to require-dev."
          fi
        continue-on-error: ${{ env.ENFORCE_GUARDRAILS != 'true' }}

      # ========== Composer Audit ==========
      - name: Composer Audit (High/Critical fail)
        if: steps.detect_api.outputs.present == 'true' && steps.detect_composer.outputs.has_composer == 'true'
        working-directory: api
        run: |
          if composer --version >/dev/null 2>&1; then
            composer audit --no-interaction --format=plain
          else
            echo "::error::Composer not available."
            exit 1
          fi
        continue-on-error: ${{ env.ENFORCE_GUARDRAILS != 'true' }}

      # ========== OpenAPI Lint (Spectral) ==========
      - name: Setup Node for Spectral
        if: steps.detect_api.outputs.present == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Spectral CLI
        if: steps.detect_api.outputs.present == 'true'
        run: npm install --global @stoplight/spectral-cli

      - name: Spectral Lint /api/openapi.json
        if: steps.detect_api.outputs.present == 'true'
        working-directory: api
        run: |
          if [ -f "openapi.json" ]; then
            spectral lint openapi.json
          else
            echo "::notice title=Spectral::openapi.json not found in /api. Will enforce once present."
          fi
        continue-on-error: ${{ env.ENFORCE_GUARDRAILS != 'true' }}

      # Friendly skip notes
      - name: Skip notice (no composer.json)
        if: steps.detect_api.outputs.present == 'true' && steps.detect_composer.outputs.has_composer != 'true'
        run: echo "::notice title=Backend::/api present but composer.json missing — skipping PHP toolchain."
      - name: Skip notice (no /api directory)
        if: steps.detect_api.outputs.present != 'true'
        run: echo "::notice title=Backend::Skipping because /api folder does not exist yet."

  frontend:
    name: Frontend (web) — Lint / Build (stub)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect /web presence
        id: detect_web
        run: |
          if [ -d "web" ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Detect package.json / lockfile
        if: steps.detect_web.outputs.present == 'true'
        id: detect_pkg
        run: |
          if [ -f "web/package.json" ]; then
            echo "has_pkg=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_pkg=false" >> "$GITHUB_OUTPUT"
          fi
          if [ -f "web/package-lock.json" ]; then
            echo "has_lock=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_lock=false" >> "$GITHUB_OUTPUT"
          fi

      # Setup Node with cache only if lockfile exists (avoids cache error)
      - name: Setup Node (with cache)
        if: steps.detect_web.outputs.present == 'true' && steps.detect_pkg.outputs.has_lock == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Setup Node (no cache)
        if: steps.detect_web.outputs.present == 'true' && steps.detect_pkg.outputs.has_lock != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install deps
        if: steps.detect_web.outputs.present == 'true' && steps.detect_pkg.outputs.has_pkg == 'true'
        working-directory: web
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: ESLint (if configured)
        if: steps.detect_web.outputs.present == 'true' && steps.detect_pkg.outputs.has_pkg == 'true'
        working-directory: web
        run: |
          if npm run | grep -q "eslint"; then
            npm run eslint
          else
            echo "::notice title=ESLint::no script defined. Add an eslint script when ready."
          fi
        continue-on-error: ${{ env.ENFORCE_GUARDRAILS != 'true' }}

      - name: Build (Vite) smoke
        if: steps.detect_web.outputs.present == 'true' && steps.detect_pkg.outputs.has_pkg == 'true'
        working-directory: web
        run: |
          if npm run | grep -q "build"; then
            npm run build
          else
            echo "::notice title=Build::no build script defined. Add Vite build when SPA exists."
          fi
        continue-on-error: ${{ env.ENFORCE_GUARDRAILS != 'true' }}

      # Friendly skip notes
      - name: Skip notice (no package.json)
        if: steps.detect_web.outputs.present == 'true' && steps.detect_pkg.outputs.has_pkg != 'true'
        run: echo "::notice title=Frontend::/web present but package.json missing — skipping Node toolchain."
      - name: Skip notice (no /web directory)
        if: steps.detect_web.outputs.present != 'true'
        run: echo "::notice title=Frontend::Skipping because /web folder does not exist yet."

  docs:
    name: Docs — Spectral (OpenAPI fragments) & Markdown lint (stub)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Spectral CLI
        run: npm install --global @stoplight/spectral-cli

      - name: Lint OpenAPI fragments (if any)
        run: |
          set +e
          FOUND=0
          for f in $(git ls-files "docs/**/*.openapi.json" "docs/**/*.swagger.json" 2>/dev/null); do
            FOUND=1
            spectral lint "$f" || exit $([ "${ENFORCE_GUARDRAILS}" = "true" ] && echo 1 || echo 0)
          done
          if [ $FOUND -eq 0 ]; then
            echo "::notice title=Spectral::no doc fragments found."
          fi
        continue-on-error: ${{ env.ENFORCE_GUARDRAILS != 'true' }}

      - name: Markdownlint (stub)
        run: |
          echo "::notice title=Markdown::Add markdownlint-cli when ready."
        continue-on-error: ${{ env.ENFORCE_GUARDRAILS != 'true' }}

  summary:
    name: Summary & Gate
    needs: [ meta, backend, frontend, docs ]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Determine overall status
        run: |
          echo "ENFORCE_GUARDRAILS=${ENFORCE_GUARDRAILS}"
          if [ "${ENFORCE_GUARDRAILS}" = "true" ]; then
            # If any needed job failed, fail the workflow
            if [ "${{ needs.meta.result }}" != "success" ] || \
               [ "${{ needs.backend.result }}" != "success" ] || \
               [ "${{ needs.frontend.result }}" != "success" ] || \
               [ "${{ needs.docs.result }}" != "success" ]; then
              echo "::error::At least one guardrail job failed under enforcement mode."
              exit 1
            fi
          else
            echo "::notice title=CI::Enforcement disabled. Set ENFORCE_GUARDRAILS=true to gate merges."
          fi
