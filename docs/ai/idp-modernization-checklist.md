# IDP Modernization & Web Server Simplification Checklist

This playbook guides CodeX through replacing the bespoke SAML and OIDC implementations with maintained libraries and streamlining the Apache vhost while keeping phpGRC deployable on a single host. Follow the steps in order; do not skip validation gates.

## 0. Global prerequisites
- [ ] Run `composer install` under `api/` to ensure autoloaders are up to date before editing PHP files.
- [ ] Review coding standards in `docs/STYLEGUIDE.md` and authentication docs in `docs/auth/` for naming and exception handling conventions.
- [ ] Keep commits atomic and prefixed with the scope (e.g., `feat(api): ...`, `refactor(auth): ...`).
- [ ] Whenever a PHP file is touched, run `phpmd` on that file as described in `AGENTS.md`.
- [ ] After each major task, run `vendor/bin/phpunit --testdox` inside `api/` and capture failing cases for remediation.

## 1. Transition SAML flow to `onelogin/php-saml`

### 1.1 Introduce the dependency and bootstrap
- [ ] Add `onelogin/php-saml` to `api/composer.json` and run `composer update onelogin/php-saml`.
- [ ] Create a configuration bridge in `api/config/auth.php` (or an appropriate new config file) exposing SP entity ID, ACS URL, certificate paths, and IdP metadata settings expected by the library.
- [ ] Register any required service bindings in `api/app/Providers/IdpServiceProvider.php` so the new adapter can be resolved via Laravel’s container.

### 1.2 Implement the adapter layer
- [ ] Add a `App\Services\Auth\SamlLibraryFactory` that builds configured `OneLogin_Saml2_Auth` instances using `SamlServiceProviderConfigResolver` data.
- [ ] Create a `App\Services\Auth\SamlLibraryBridge` (or similar) that wraps library calls for: metadata parsing, AuthnRequest creation, logout, and response validation. Ensure it surfaces value objects compatible with existing controllers.
- [ ] Refactor `api/app/Auth/Idp/Drivers/SamlIdpDriver.php` to delegate to the bridge for remote metadata fetching, health checks, and relay state issuance. Remove direct XML handling.
- [ ] Replace `SamlAuthnRequestBuilder`, `SamlMetadataService`, and `SamlStateTokenFactory` usage inside controllers with the bridge or Laravel session helpers. Delete superseded services after verifying no other classes reference them (`rg "SamlAuthnRequestBuilder" api/app`).

### 1.3 Update controllers and requests
- [ ] Modify `SamlRedirectController` to call the new bridge for generating the redirect URL and to store RelayState data via session or the library’s helper instead of custom tokens.
- [ ] Update `SamlAssertionConsumerController` to validate the SAML response using `OneLogin_Saml2_Auth`. Map successful assertions into existing provisioning logic.
- [ ] Ensure request validators under `api/app/Http/Requests/Auth/` reflect any new configuration requirements (e.g., certificate paths instead of raw metadata XML).

### 1.4 Testing and cleanup
- [ ] Rewrite or adjust feature tests under `api/tests/Feature/Auth/` to mock the library and assert correct redirects and ACS handling. Prefer Laravel’s HTTP testing utilities.
- [ ] Add unit tests for the bridge to confirm that failure states from `OneLogin_Saml2_Error` convert into domain exceptions.
- [ ] Remove obsolete configuration keys and update documentation under `docs/auth/` to describe how to provide metadata or certificates for the new flow.
- [ ] Run `phpunit`, `phpstan`, `psalm`, and targeted `phpmd` checks; resolve findings before proceeding.

## 2. Transition OIDC flow to `jumbojett/openid-connect-php`

### 2.1 Dependency and configuration
- [ ] Require `jumbojett/openid-connect-php` via Composer and update the lockfile.
- [ ] Extend `api/config/auth.php` (or create a dedicated OIDC config file) to expose issuer, client credentials, redirect URIs, and timeout settings compatible with the library.
- [ ] Bind a `OidcClientFactory` service inside `IdpServiceProvider` that prepares `Jumbojett\OpenIDConnectClient` instances with discovery and PKCE enabled.

### 2.2 Refactor driver and authenticator
- [ ] Replace manual HTTP discovery inside `api/app/Auth/Idp/Drivers/OidcIdpDriver.php` with calls to the factory and library discovery cache.
- [ ] Update `api/app/Services/Auth/OidcAuthenticator.php` so the authorization URL, token exchange, nonce generation, and ID token verification use the library’s methods. Retain domain-specific provisioning logic and error mapping.
- [ ] Remove redundant helpers (`OidcProviderMetadataService`, ad-hoc JWKS parsing) once the new client covers those responsibilities.
- [ ] Adjust `OidcStateStore` to work with the nonce/state values generated by the library (or replace it with Laravel session storage if redundant).

### 2.3 Controllers and validation
- [ ] Refactor `OidcAuthorizeController` and `OidcLoginController` to expect the library-managed URLs and tokens. Ensure they handle exceptions thrown by `OpenIDConnectClientException`.
- [ ] Update validation traits (`ValidatesOidcIdpConfig`) to align with the configuration schema the library expects (e.g., JWKS vs discovery URL).

### 2.4 Tests and documentation
- [ ] Write unit tests for the new factory that fake HTTP discovery responses and assert caching behavior.
- [ ] Update feature tests that cover OIDC login to simulate the new state/nonce handling and token payloads.
- [ ] Document library-specific deployment prerequisites (e.g., enabling cURL extensions) under `docs/auth/`.
- [ ] Execute the full test suite and static analysis just as in §1.4.

## 3. Simplify Apache vhost while keeping single-host deployment

### 3.1 Inventory and backup
- [ ] Copy the current `scripts/phpgrc-https.conf` to a dated backup before editing (`cp scripts/phpgrc-https.conf scripts/phpgrc-https.conf.bak-$(date +%Y%m%d)`).
- [ ] Review Laravel’s shipped `api/public/.htaccess` to confirm rewrite rules already cover SPA history fallback and API routing.

### 3.2 Rework the vhost
- [ ] Set the vhost `DocumentRoot` to `api/public` and enable `AllowOverride All` so `.htaccess` handles rewrites.
- [ ] Remove custom `RewriteCond` blocks that duplicate Laravel routing. Replace them with `FallbackResource /index.php` (Apache 2.4+) or rely on `.htaccess`.
- [ ] Keep or port only the necessary static asset aliases (e.g., pointing `/assets/` to the built SPA under `api/public/assets`). Ensure directory permissions are correct.
- [ ] Move application-specific security headers (CSP, frame options) into a Laravel middleware (create `api/app/Http/Middleware/SecurityHeaders.php`) and register it in `app/Http/Kernel.php`.
- [ ] Retain transport-level directives (SSL, HSTS) and any reverse proxies required for docs, but remove redundant SPA rewrites.

### 3.3 Validation
- [ ] Update any deployment scripts or Ansible roles that copy the vhost so they reference the simplified configuration.
- [ ] Provision a local environment (e.g., `docker-compose` or the existing dev VM) and verify: static asset load, SPA navigation refresh, API endpoints, and health check routes.
- [ ] If using Nginx in other environments, mirror the simplified behavior with `try_files $uri $uri/ /index.php$is_args$args;` in the server block.
- [ ] Document the new server expectations in `docs/ops/` or `docs/ai/` as appropriate.

## 4. Final verification and rollout
- [ ] Ensure all old classes removed in §1 and §2 are no longer referenced (`composer dump-autoload --optimize` and rerun tests).
- [ ] Run `npm run build` under `web/` to confirm the SPA still compiles and outputs to the expected directory consumed by the PHP app.
- [ ] Execute end-to-end login flows against staging IdPs for both SAML and OIDC.
- [ ] Prepare release notes summarizing library adoption, configuration changes, and web server adjustments.
- [ ] Tag the release only after CI and manual smoke tests pass.
