# HTTPS-only vhost for phpGRC (no port 80)
# DocumentRoot points at the "current" symlink managed by the deploy workflow.

<VirtualHost *:443>
    ServerName phpgrc.gruntlabs.net

    # --- SSL ---
    SSLEngine on
    # Replace these three paths with your real certs/chain.
    SSLCertificateFile      /etc/ssl/certs/gruntlabs.pem
    SSLCertificateKeyFile   /etc/ssl/private/gruntlabs.key

    # --- App path ---
    DocumentRoot /var/www/phpgrc/current/api/public
    <Directory /var/www/phpgrc/current/api/public>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.html index.php

        <Files "index.html">
            Header set Cache-Control "no-store, max-age=0"
        </Files>

        SetEnvIfNoCase Authorization "^(.*)" HTTP_AUTHORIZATION=$1
        RequestHeader set Authorization "%{HTTP_AUTHORIZATION}e" env=HTTP_AUTHORIZATION
    </Directory>

    <FilesMatch "\.php$">
        SetHandler "proxy:unix:/run/php/php8.3-fpm.sock|fcgi://localhost"
    </FilesMatch>

    Alias /assets/ /var/www/phpgrc/current/api/public/assets/
    <Directory /var/www/phpgrc/current/api/public/assets>
        Options -Indexes
        AllowOverride None
        Require all granted
        Header set Cache-Control "public, max-age=31536000, immutable"
    </Directory>

    # Security headers (baseline)
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "0"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    # Minimal CSP for placeholder; will be revisited with SPA
    Header always set Content-Security-Policy "default-src 'self'; connect-src 'self' https://login.microsoftonline.com; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data:; frame-ancestors 'self'; base-uri 'self'"

    # HSTS (preload-ready) — safe now since we’re HTTPS-only by requirement
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Logs
    ErrorLog  /var/log/apache2/phpgrc_error.log
    CustomLog /var/log/apache2/phpgrc_access.log combined

    # Routing
    RewriteEngine On

    RewriteCond %{REQUEST_URI} \.(?:css|js|map|woff2?|woff|svg|png|jpe?g|webp|ico)$ [NC]
    RewriteRule .* - [L,END]

    # Serve built SPA assets and other static files directly
    RewriteRule ^assets/ - [L]

    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{HTTP_ACCEPT} (text/html|application/xhtml\+xml) [NC]
    RewriteCond %{DOCUMENT_ROOT}/index.html -f
    RewriteRule ^ index.html [L,END]

    # Laravel API and JSON endpoints
    RewriteCond %{REQUEST_METHOD} !^(GET|HEAD)$ [OR]
    RewriteCond %{HTTP_X_REQUESTED_WITH} XMLHttpRequest [NC,OR]
    RewriteCond %{HTTP_ACCEPT} !(text/html|application/xhtml\+xml) [NC]
    RewriteCond %{REQUEST_URI} ^/(admin|audit|auth|avatar|broadcasting|dashboard|evidence|exports|favicon\.ico|health|integrations|me|metrics|oauth|openapi\.json|openapi\.yaml|rbac|reports|sanctum|settings|setup|telescope|up|users|_ignition|inertia) [NC]
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^ index.php [QSA,L]

    # SPA history-mode fallback
    RewriteCond %{REQUEST_URI} !^/(admin|audit|auth|avatar|broadcasting|dashboard|evidence|exports|favicon\.ico|health|integrations|me|metrics|oauth|openapi\.json|openapi\.yaml|rbac|reports|sanctum|settings|setup|telescope|up|users|_ignition|inertia) [NC]
    RewriteCond %{DOCUMENT_ROOT}/index.html -f
    RewriteRule ^$ index.html [L]

    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} !^/(admin|audit|auth|avatar|broadcasting|dashboard|evidence|exports|favicon\.ico|health|integrations|me|metrics|oauth|openapi\.json|openapi\.yaml|rbac|reports|sanctum|settings|setup|telescope|up|users|_ignition|inertia) [NC]
    RewriteCond %{DOCUMENT_ROOT}/index.html -f
    RewriteRule ^ index.html [L]

    # Don’t leak directory listings anywhere else
    <Directory />
        Options -Indexes
    </Directory>
</VirtualHost>

# Ensure only 443 is used for this vhost
# No :80 vhost provided by design (HTTPS-only)

<VirtualHost *:8443>
    ServerName phpgrc.gruntlabs.net

    SSLEngine on
    SSLCertificateFile      /etc/ssl/certs/gruntlabs.pem
    SSLCertificateKeyFile   /etc/ssl/private/gruntlabs.key

    DocumentRoot /var/www/phpgrc/current/api/public/api-docs
    DirectoryIndex index.html

    <Directory /var/www/phpgrc/current/api/public/api-docs>
        Options -Indexes
        AllowOverride None
        Require all granted
    </Directory>

    RewriteEngine On
    RewriteRule ^/?$ index.html [L]
    RewriteRule ^/api-docs/?$ index.html [L]

    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "0"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set Content-Security-Policy "default-src 'self'; connect-src 'self' https://login.microsoftonline.com; script-src 'self' 'unsafe-inline' https://cdn.redoc.ly; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data:; frame-ancestors 'self'; base-uri 'self'"

    SSLProxyEngine On
    ProxyPreserveHost On
    ProxyPass        /openapi.json https://phpgrc.gruntlabs.net/openapi.json retry=0
    ProxyPassReverse /openapi.json https://phpgrc.gruntlabs.net/openapi.json
    ProxyPass        /openapi.yaml https://phpgrc.gruntlabs.net/openapi.yaml retry=0
    ProxyPassReverse /openapi.yaml https://phpgrc.gruntlabs.net/openapi.yaml

    ErrorLog  /var/log/apache2/phpgrc_docs_error.log
    CustomLog /var/log/apache2/phpgrc_docs_access.log combined
</VirtualHost>
